#!/bin/bash

# Comprueba si se ha proporcionado un directorio como argumento
if [ -z "$1" ]; then
  echo "Uso: $0 /ruta/a/tu/carpeta"
  exit 1
fi

# Directorio de entrada
input_dir="$1"

# Nombre del directorio de salida con el sufijo _trans
output_dir="${input_dir}_trans"

# Crea el directorio de salida si no existe
mkdir -p "$output_dir"

# Comprueba si el directorio de entrada contiene archivos .mkv
shopt -s nullglob
mkv_files=("$input_dir"/*.mkv)
if [ ${#mkv_files[@]} -eq 0 ]; then
  echo "No se encontraron archivos .mkv en el directorio $input_dir"
  exit 1
fi

# Recorre todos los archivos .mkv en el directorio de entrada
for input_file in "${mkv_files[@]}"; do
  # Obtiene el nombre del archivo sin la extensión
  filename=$(basename -- "$input_file")
  filename="${filename%.*}"

  # Nombre del archivo de salida en el nuevo directorio con la extensión .mp4
  output_file="$output_dir/${filename}.mp4"

  # Ejecuta FFmpeg para convertir el archivo a H.264 y AAC, manteniendo los metadatos
  echo "Convirtiendo: $input_file -> $output_file"
  ffmpeg -i "$input_file" -c:v libx264 -c:a aac -map_metadata 0 "$output_file"

  # Verifica si el archivo de salida fue creado
  if [[ -f "$output_file" ]]; then
    echo "Éxito: $output_file fue creado."
  else
    echo "Error: No se pudo crear $output_file."
  fi
done

echo "Conversión completada."
